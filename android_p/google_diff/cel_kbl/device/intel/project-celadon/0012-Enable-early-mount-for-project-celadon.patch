From 36257ae3f2d6c4eb787fd15e1da0b912bc609ab5 Mon Sep 17 00:00:00 2001
From: Meng Xianglin <xianglinx.meng@intel.com>
Date: Fri, 18 Jan 2019 14:31:33 +0800
Subject: [PATCH 12/18] Enable early mount for project-celadon

Tracked-On: OAM-69202
Signed-off-by: Meng Xianglin <xianglinx.meng@intel.com>
---
 cel_apl/AndroidBoard.mk |  7 +++++++
 cel_apl/BoardConfig.mk  |  6 ++++++
 cel_apl/config.asl      | 37 +++++++++++++++++++++++++++++++++++++
 celadon/AndroidBoard.mk |  7 +++++++
 celadon/BoardConfig.mk  |  6 ++++++
 celadon/config.asl      | 37 +++++++++++++++++++++++++++++++++++++
 6 files changed, 100 insertions(+)
 create mode 100644 cel_apl/config.asl
 create mode 100644 celadon/config.asl

diff --git a/cel_apl/AndroidBoard.mk b/cel_apl/AndroidBoard.mk
index 7e50a55..b502d2d 100644
--- a/cel_apl/AndroidBoard.mk
+++ b/cel_apl/AndroidBoard.mk
@@ -566,6 +566,13 @@ gptimage: $(GPTIMAGE_BIN)
 #KERNEL_CAR_DIFFCONFIG = $(wildcard $(KERNEL_CONFIG_PATH)/car_diffconfig)
 #KERNEL_DIFFCONFIG += $(KERNEL_CAR_DIFFCONFIG)
 ##############################################################
+# Source: device/intel/mixins/groups/firststage-mount/true/AndroidBoard.mk
+##############################################################
+FIRST_STAGE_MOUNT_CFG_FILE := $(TARGET_DEVICE_DIR)/config.asl
+
+$(FIRSTSTAGE_MOUNT_SSDT): $(FIRST_STAGE_MOUNT_CFG_FILE) $(IASL)
+	$(hide) $(IASL) -p $(@:.aml=) $(FIRST_STAGE_MOUNT_CFG_FILE);
+##############################################################
 # Source: device/intel/mixins/groups/vndk/default/AndroidBoard.mk
 ##############################################################
 define define-vndk-sp-lib
diff --git a/cel_apl/BoardConfig.mk b/cel_apl/BoardConfig.mk
index 9af95a0..0c4051c 100644
--- a/cel_apl/BoardConfig.mk
+++ b/cel_apl/BoardConfig.mk
@@ -499,4 +499,10 @@ BOARD_SEPOLICY_M4DEFS += module_swap=true
 ##############################################################
 BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/power
 
+##############################################################
+# Source: device/intel/mixins/groups/firststage-mount/true/BoardConfig.mk
+##############################################################
+BOARD_FIRSTSTAGE_MOUNT_ENABLE := true
+BOARD_KERNEL_CMDLINE += androidboot.android_dt_dir=/sys/bus/platform/devices/ANDR0001:00/properties/android/
+FIRSTSTAGE_MOUNT_SSDT = $(PRODUCT_OUT)/firststage-mount.aml
 # ------------------ END MIX-IN DEFINITIONS ------------------
diff --git a/cel_apl/config.asl b/cel_apl/config.asl
new file mode 100644
index 0000000..f4df5da
--- /dev/null
+++ b/cel_apl/config.asl
@@ -0,0 +1,37 @@
+//############# BEGIN MIX-IN DEFINITIONS ############## -->
+//Mix-In definitions are auto-generated by mixin-update -->
+//##################################################### -->
+//-- Source: device/intel/mixins/groups/firststage-mount/true/config.asl -->
+//##################################################### -->
+//ACPI module device to config First-Stage Mount
+DefinitionBlock ("firststage-mount.aml", "SSDT", 1, "INTEL ", "android", 0x00001000)
+{
+Scope (\)
+{
+External (\_SB.CFG0, DeviceObj)
+Scope(_SB)
+{
+        Device (ANDT)
+        {
+            Name (_HID, "ANDR0001")
+            Name (_STR, Unicode("android device tree"))  // Optional
+
+            Name (_DSD, Package () {
+                ToUUID("daffd814-6eba-4d8c-8a91-bc9bbf4aa301"),
+                Package () {
+                    Package () {"android.compatible", "android,firmware"},
+                    Package () {"android.vbmeta.compatible","android,vbmeta"},
+                    Package () {"android.vbmeta.parts","vbmeta,boot,system,vendor,tos"},
+                    Package () {"android.fstab.compatible", "android,fstab"},
+                    Package () {"android.fstab.vendor.compatible", "android,vendor"},
+                    Package () {"android.fstab.vendor.dev", "/dev/block/pci/pci0000:00/0000:00:ff.ff/by-name/vendor"},  // Varies with platform
+                    Package () {"android.fstab.vendor.type", "ext4"},  // May vary with platform
+                    Package () {"android.fstab.vendor.mnt_flags", "ro"},  // May vary with platform
+                    Package () {"android.fstab.vendor.fsmgr_flags", "wait,slotselect,avb"},  // May vary with platform
+                }
+            })
+        }
+}
+}
+}
+//############## END MIX-IN DEFINITIONS ############### -->
diff --git a/celadon/AndroidBoard.mk b/celadon/AndroidBoard.mk
index bd33d9e..ccd28bf 100644
--- a/celadon/AndroidBoard.mk
+++ b/celadon/AndroidBoard.mk
@@ -560,6 +560,13 @@ $(GPTIMAGE_BIN): \
 .PHONY: gptimage
 gptimage: $(GPTIMAGE_BIN)
 ##############################################################
+# Source: device/intel/mixins/groups/firststage-mount/true/AndroidBoard.mk
+##############################################################
+FIRST_STAGE_MOUNT_CFG_FILE := $(TARGET_DEVICE_DIR)/config.asl
+
+$(FIRSTSTAGE_MOUNT_SSDT): $(FIRST_STAGE_MOUNT_CFG_FILE) $(IASL)
+	$(hide) $(IASL) -p $(@:.aml=) $(FIRST_STAGE_MOUNT_CFG_FILE);
+##############################################################
 # Source: device/intel/mixins/groups/vndk/default/AndroidBoard.mk
 ##############################################################
 define define-vndk-sp-lib
diff --git a/celadon/BoardConfig.mk b/celadon/BoardConfig.mk
index 338807c..617898a 100644
--- a/celadon/BoardConfig.mk
+++ b/celadon/BoardConfig.mk
@@ -494,4 +494,10 @@ BOARD_SEPOLICY_M4DEFS += module_swap=true
 ##############################################################
 BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/power
 
+##############################################################
+# Source: device/intel/mixins/groups/firststage-mount/true/BoardConfig.mk
+##############################################################
+BOARD_FIRSTSTAGE_MOUNT_ENABLE := true
+BOARD_KERNEL_CMDLINE += androidboot.android_dt_dir=/sys/bus/platform/devices/ANDR0001:00/properties/android/
+FIRSTSTAGE_MOUNT_SSDT = $(PRODUCT_OUT)/firststage-mount.aml
 # ------------------ END MIX-IN DEFINITIONS ------------------
diff --git a/celadon/config.asl b/celadon/config.asl
new file mode 100644
index 0000000..f4df5da
--- /dev/null
+++ b/celadon/config.asl
@@ -0,0 +1,37 @@
+//############# BEGIN MIX-IN DEFINITIONS ############## -->
+//Mix-In definitions are auto-generated by mixin-update -->
+//##################################################### -->
+//-- Source: device/intel/mixins/groups/firststage-mount/true/config.asl -->
+//##################################################### -->
+//ACPI module device to config First-Stage Mount
+DefinitionBlock ("firststage-mount.aml", "SSDT", 1, "INTEL ", "android", 0x00001000)
+{
+Scope (\)
+{
+External (\_SB.CFG0, DeviceObj)
+Scope(_SB)
+{
+        Device (ANDT)
+        {
+            Name (_HID, "ANDR0001")
+            Name (_STR, Unicode("android device tree"))  // Optional
+
+            Name (_DSD, Package () {
+                ToUUID("daffd814-6eba-4d8c-8a91-bc9bbf4aa301"),
+                Package () {
+                    Package () {"android.compatible", "android,firmware"},
+                    Package () {"android.vbmeta.compatible","android,vbmeta"},
+                    Package () {"android.vbmeta.parts","vbmeta,boot,system,vendor,tos"},
+                    Package () {"android.fstab.compatible", "android,fstab"},
+                    Package () {"android.fstab.vendor.compatible", "android,vendor"},
+                    Package () {"android.fstab.vendor.dev", "/dev/block/pci/pci0000:00/0000:00:ff.ff/by-name/vendor"},  // Varies with platform
+                    Package () {"android.fstab.vendor.type", "ext4"},  // May vary with platform
+                    Package () {"android.fstab.vendor.mnt_flags", "ro"},  // May vary with platform
+                    Package () {"android.fstab.vendor.fsmgr_flags", "wait,slotselect,avb"},  // May vary with platform
+                }
+            })
+        }
+}
+}
+}
+//############## END MIX-IN DEFINITIONS ############### -->
-- 
1.9.1

