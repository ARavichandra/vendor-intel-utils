From 390000e00727d315b57fdc335e0856db2995aad7 Mon Sep 17 00:00:00 2001
From: sgnanase <sundar.gnanasekaran@intel.com>
Date: Tue, 29 Jan 2019 15:29:49 +0530
Subject: [PATCH] CELADON-TREBLE-Mixin-up

Tracked-On: none
Signed-off-by: rnaidu <ramya.v.naidu@intel.com>
---
 cel_kbl/AndroidBoard.mk |  7 +++++++
 cel_kbl/BoardConfig.mk  |  6 ++++++
 cel_kbl/config.asl      | 37 +++++++++++++++++++++++++++++++++++++
 cel_kbl/fstab           |  2 +-
 cel_kbl/mixins.spec     |  1 +
 5 files changed, 52 insertions(+), 1 deletion(-)
 create mode 100644 cel_kbl/config.asl

diff --git a/cel_kbl/AndroidBoard.mk b/cel_kbl/AndroidBoard.mk
index e5e142f..80c1d01 100644
--- a/cel_kbl/AndroidBoard.mk
+++ b/cel_kbl/AndroidBoard.mk
@@ -95,6 +95,13 @@ installclean: FILES += $(KERNEL_OUT) $(PRODUCT_OUT)/kernel
 .PHONY: kernel
 kernel: $(PRODUCT_OUT)/kernel
 ##############################################################
+# Source: device/intel/mixins/groups/firststage-mount/true/AndroidBoard.mk
+##############################################################
+FIRST_STAGE_MOUNT_CFG_FILE := $(TARGET_DEVICE_DIR)/config.asl
+
+$(FIRSTSTAGE_MOUNT_SSDT): $(FIRST_STAGE_MOUNT_CFG_FILE) $(IASL)
+	$(hide) $(IASL) -p $(@:.aml=) $(FIRST_STAGE_MOUNT_CFG_FILE);
+##############################################################
 # Source: device/intel/mixins/groups/vendor-partition/true/AndroidBoard.mk
 ##############################################################
 
diff --git a/cel_kbl/BoardConfig.mk b/cel_kbl/BoardConfig.mk
index bc3f723..fbb5e94 100644
--- a/cel_kbl/BoardConfig.mk
+++ b/cel_kbl/BoardConfig.mk
@@ -144,6 +144,12 @@ BOARD_FLASHFILES += $(PRODUCT_OUT)/vbmeta.img
 # Now use AVB to support A/B slot
 PRODUCT_STATIC_BOOT_CONTROL_HAL := bootctrl.avb libavb_user
 ##############################################################
+# Source: device/intel/mixins/groups/firststage-mount/true/BoardConfig.mk
+##############################################################
+BOARD_FIRSTSTAGE_MOUNT_ENABLE := true
+BOARD_KERNEL_CMDLINE += androidboot.android_dt_dir=/sys/bus/platform/devices/ANDR0001:00/properties/android/
+FIRSTSTAGE_MOUNT_SSDT = $(PRODUCT_OUT)/firststage-mount.aml
+##############################################################
 # Source: device/intel/mixins/groups/vendor-partition/true/BoardConfig.mk
 ##############################################################
 # Those 3 lines are required to enable vendor image generation.
diff --git a/cel_kbl/config.asl b/cel_kbl/config.asl
new file mode 100644
index 0000000..f4df5da
--- /dev/null
+++ b/cel_kbl/config.asl
@@ -0,0 +1,37 @@
+//############# BEGIN MIX-IN DEFINITIONS ############## -->
+//Mix-In definitions are auto-generated by mixin-update -->
+//##################################################### -->
+//-- Source: device/intel/mixins/groups/firststage-mount/true/config.asl -->
+//##################################################### -->
+//ACPI module device to config First-Stage Mount
+DefinitionBlock ("firststage-mount.aml", "SSDT", 1, "INTEL ", "android", 0x00001000)
+{
+Scope (\)
+{
+External (\_SB.CFG0, DeviceObj)
+Scope(_SB)
+{
+        Device (ANDT)
+        {
+            Name (_HID, "ANDR0001")
+            Name (_STR, Unicode("android device tree"))  // Optional
+
+            Name (_DSD, Package () {
+                ToUUID("daffd814-6eba-4d8c-8a91-bc9bbf4aa301"),
+                Package () {
+                    Package () {"android.compatible", "android,firmware"},
+                    Package () {"android.vbmeta.compatible","android,vbmeta"},
+                    Package () {"android.vbmeta.parts","vbmeta,boot,system,vendor,tos"},
+                    Package () {"android.fstab.compatible", "android,fstab"},
+                    Package () {"android.fstab.vendor.compatible", "android,vendor"},
+                    Package () {"android.fstab.vendor.dev", "/dev/block/pci/pci0000:00/0000:00:ff.ff/by-name/vendor"},  // Varies with platform
+                    Package () {"android.fstab.vendor.type", "ext4"},  // May vary with platform
+                    Package () {"android.fstab.vendor.mnt_flags", "ro"},  // May vary with platform
+                    Package () {"android.fstab.vendor.fsmgr_flags", "wait,slotselect,avb"},  // May vary with platform
+                }
+            })
+        }
+}
+}
+}
+//############## END MIX-IN DEFINITIONS ############### -->
diff --git a/cel_kbl/fstab b/cel_kbl/fstab
index 131b459..89e6522 100644
--- a/cel_kbl/fstab
+++ b/cel_kbl/fstab
@@ -15,7 +15,7 @@
 # Following line is required if you use a vendor image.
 # If the vendor image is not used,
 # following line should be commented with the related ones in BoardConfig.mk
-/dev/block/by-name/vendor       /vendor         ext4    ro                                         wait,slotselect,avb
+#First-Stage Mount is enabled, the mount of vendor partition is moved to the configure in ACPI SSDT table.
 ##############################################################
 # Source: device/intel/mixins/groups/config-partition/enabled/fstab
 ##############################################################
diff --git a/cel_kbl/mixins.spec b/cel_kbl/mixins.spec
index a0a9d57..e8d7df5 100644
--- a/cel_kbl/mixins.spec
+++ b/cel_kbl/mixins.spec
@@ -56,3 +56,4 @@ gptbuild: true(size=14G)
 device-type: car
 swap:zram(size=1073741824,swappiness=false,hardware=cel_kbl)
 power: true
+firststage-mount: true
-- 
2.20.1

