From e3d1862f09c028a6803f9e17a490279766236239 Mon Sep 17 00:00:00 2001
From: "Chen, Yu" <yu.y.chen@intel.com>
Date: Sat, 22 Oct 2022 19:46:00 +0800
Subject: [PATCH] Add stack protect build flags

Signed-off-by: Chen, Yu <yu.y.chen@intel.com>
Change-Id: Ifa17544903dc688cf506ea504587d4f778759c5c
---
 android/mesa3d_cross.mk | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/android/mesa3d_cross.mk b/android/mesa3d_cross.mk
index a927b6eb7ab..9091c1b2b8c 100644
--- a/android/mesa3d_cross.mk
+++ b/android/mesa3d_cross.mk
@@ -180,12 +180,22 @@ define m-lld-flags-cleaned
     $(m-lld-flags))))))))
 endef
 
+STACK_PROTECT_FLAG := \
+       -ffunction-sections             \
+       -funwind-tables                 \
+       -fstack-protector-strong        \
+       -Wa,--noexecstack               \
+       -D_FORTIFY_SOURCE=2             \
+       -Wstrict-aliasing=2             \
+       -Werror=format-security
+
 define m-cpp-flags
   $(PRIVATE_TARGET_GLOBAL_CFLAGS) \
   $(PRIVATE_TARGET_GLOBAL_CPPFLAGS) \
   $(PRIVATE_ARM_CFLAGS) \
   $(PRIVATE_RTTI_FLAG) \
   $(PRIVATE_CFLAGS) \
+  $(STACK_PROTECT_FLAG) \
   $(PRIVATE_CPPFLAGS) \
   $(PRIVATE_DEBUG_CFLAGS) \
   $(PRIVATE_CFLAGS_NO_OVERRIDE) \
@@ -197,6 +207,7 @@ define m-c-flags
   $(PRIVATE_TARGET_GLOBAL_CONLYFLAGS) \
   $(PRIVATE_ARM_CFLAGS) \
   $(PRIVATE_CFLAGS) \
+  $(STACK_PROTECT_FLAG) \
   $(PRIVATE_CONLYFLAGS) \
   $(PRIVATE_DEBUG_CFLAGS) \
   $(PRIVATE_CFLAGS_NO_OVERRIDE)
-- 
2.33.1

