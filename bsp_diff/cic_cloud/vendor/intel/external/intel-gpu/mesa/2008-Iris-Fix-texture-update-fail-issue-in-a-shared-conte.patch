From 3d549f8f240be133f927c8582f8d7e1ad50623b7 Mon Sep 17 00:00:00 2001
From: yuchen5 <yu.y.chen@intel.com>
Date: Thu, 5 May 2022 14:37:50 +0800
Subject: [PATCH] Iris: Fix texture update fail issue in a shared context

Issue: Danmaku in Youku shows abnormal
Cause: When using Multi-thread rendering,
       the resources updated in a shared
       context are not flushed in time.
Fix: Add shareCtx flag in iris_context,
     and directly flush batch in
     iris_transfer_flush_region.

Signed-off-by: yuchen5 <yu.y.chen@intel.com>
Change-Id: I3c3c58f8c4f9c412af4e8f551d116cb8c4a4b6b1
---
 src/gallium/drivers/iris/iris_context.c  |  5 +++++
 src/gallium/drivers/iris/iris_context.h  |  3 +++
 src/gallium/drivers/iris/iris_resource.c | 10 ++++++++++
 src/gallium/include/pipe/p_defines.h     |  3 +++
 src/mesa/state_tracker/st_manager.c      |  3 +++
 5 files changed, 24 insertions(+)

diff --git a/src/gallium/drivers/iris/iris_context.c b/src/gallium/drivers/iris/iris_context.c
index 70dd21176a4..e5b95c00fe3 100644
--- a/src/gallium/drivers/iris/iris_context.c
+++ b/src/gallium/drivers/iris/iris_context.c
@@ -376,6 +376,11 @@ iris_create_context(struct pipe_screen *pscreen, void *priv, unsigned flags)
    screen->vtbl.init_render_context(&ice->batches[IRIS_BATCH_RENDER]);
    screen->vtbl.init_compute_context(&ice->batches[IRIS_BATCH_COMPUTE]);
 
+   if (flags & PIPE_CONTEXT_SHARE_STATE)
+      ice->bShareCtx = true;
+   else
+      ice->bShareCtx = false;
+
    if (!(flags & PIPE_CONTEXT_PREFER_THREADED))
       return ctx;
 
diff --git a/src/gallium/drivers/iris/iris_context.h b/src/gallium/drivers/iris/iris_context.h
index 7b73c7be06b..55ffd80d638 100644
--- a/src/gallium/drivers/iris/iris_context.h
+++ b/src/gallium/drivers/iris/iris_context.h
@@ -835,6 +835,9 @@ struct iris_context {
       /** Resource holding the pixel pipe hashing tables. */
       struct pipe_resource *pixel_hashing_tables;
    } state;
+
+   /** share state with other context or not */
+   bool bShareCtx;
 };
 
 #define perf_debug(dbg, ...) do {                      \
diff --git a/src/gallium/drivers/iris/iris_resource.c b/src/gallium/drivers/iris/iris_resource.c
index bc66407359a..24f48d5251c 100644
--- a/src/gallium/drivers/iris/iris_resource.c
+++ b/src/gallium/drivers/iris/iris_resource.c
@@ -2478,8 +2478,12 @@ iris_transfer_flush_region(struct pipe_context *ctx,
    struct iris_resource *res = (struct iris_resource *) xfer->resource;
    struct iris_transfer *map = (void *) xfer;
 
+   bool needFlush = false;
    if (map->staging)
+   {
       iris_flush_staging_region(xfer, box);
+      needFlush = ice->bShareCtx;
+   }
 
    if (res->base.b.target == PIPE_BUFFER) {
       util_range_add(&res->base.b, &res->valid_buffer_range, box->x, box->x + box->width);
@@ -2489,6 +2493,12 @@ iris_transfer_flush_region(struct pipe_context *ctx,
     * any PIPE_CONTROLs to a batch.
     */
    iris_dirty_for_history(ice, res);
+   if (needFlush)
+   {
+      for (int i = 0; i < IRIS_BATCH_COUNT; i++) {
+         iris_batch_flush(&ice->batches[i]);
+      }
+   }
 }
 
 static void
diff --git a/src/gallium/include/pipe/p_defines.h b/src/gallium/include/pipe/p_defines.h
index 50e0404a1e9..7a6beb923f4 100644
--- a/src/gallium/include/pipe/p_defines.h
+++ b/src/gallium/include/pipe/p_defines.h
@@ -440,6 +440,9 @@ enum pipe_flush_flags
 /** Stop execution if the device is reset. */
 #define PIPE_CONTEXT_LOSE_CONTEXT_ON_RESET (1 << 6)
 
+/** Share state with other context. */
+#define PIPE_CONTEXT_SHARE_STATE    (1 << 7)
+
 /**
  * Flags for pipe_context::memory_barrier.
  */
diff --git a/src/mesa/state_tracker/st_manager.c b/src/mesa/state_tracker/st_manager.c
index e49ce3ae6f2..1488a8ced13 100644
--- a/src/mesa/state_tracker/st_manager.c
+++ b/src/mesa/state_tracker/st_manager.c
@@ -1062,6 +1062,9 @@ st_api_create_context(struct st_api *stapi, struct st_manager *smapi,
    if (attribs->flags & ST_CONTEXT_FLAG_RESET_NOTIFICATION_ENABLED)
       ctx_flags |= PIPE_CONTEXT_LOSE_CONTEXT_ON_RESET;
 
+   if (shared_stctxi != NULL)
+      ctx_flags |= PIPE_CONTEXT_SHARE_STATE;
+
    pipe = smapi->screen->context_create(smapi->screen, NULL, ctx_flags);
    if (!pipe) {
       *error = ST_CONTEXT_ERROR_NO_MEMORY;
-- 
2.33.1

