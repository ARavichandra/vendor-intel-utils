From e3191a859ca52a6d30b5d2e176b626e934e9ee03 Mon Sep 17 00:00:00 2001
From: "Chen, Yu" <yu.y.chen@intel.com>
Date: Tue, 1 Nov 2022 10:43:53 +0800
Subject: [PATCH] add vulkan fps print

Tracked-On: OAM-104364
Change-Id: Id7d9740a2173ff3491c68c125acda33979ae0adc
Signed-off-by: Chen, Yu <yu.y.chen@intel.com>
---
 vulkan/libvulkan/swapchain.cpp | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/vulkan/libvulkan/swapchain.cpp b/vulkan/libvulkan/swapchain.cpp
index d3ed88d2eb..44b3629e0c 100644
--- a/vulkan/libvulkan/swapchain.cpp
+++ b/vulkan/libvulkan/swapchain.cpp
@@ -30,10 +30,16 @@
 #include <algorithm>
 #include <unordered_set>
 #include <vector>
+#include <cutils/log.h>
+#include <utils/Timers.h>
+#include <android-base/properties.h>
 
 #include "driver.h"
 
 using android::hardware::graphics::common::V1_0::BufferUsage;
+using android::base::GetIntProperty;
+static int64_t lastSwapTime = 0;
+static int     swapCount = 0;
 
 namespace vulkan {
 namespace driver {
@@ -1022,6 +1028,7 @@ VkResult CreateSwapchainKHR(VkDevice device,
 
     int err;
     VkResult result = VK_SUCCESS;
+    ALOGI("CreateSwapchainKHR with presentMode=%d\n", create_info->presentMode);
 
     ALOGV("vkCreateSwapchainKHR: surface=0x%" PRIx64
           " minImageCount=%u imageFormat=%u imageColorSpace=%u"
@@ -1564,6 +1571,23 @@ static VkResult WorstPresentResult(VkResult a, VkResult b) {
 VKAPI_ATTR
 VkResult QueuePresentKHR(VkQueue queue, const VkPresentInfoKHR* present_info) {
     ATRACE_CALL();
+    int printFPS = 0;
+    printFPS = android::base::GetIntProperty("debug.egl.printFPS", 0);
+
+    if (printFPS > 0) {
+        int frameCount = printFPS;
+        swapCount++;
+        if (swapCount % frameCount == 0) {
+            int64_t currentNS = systemTime(SYSTEM_TIME_MONOTONIC);
+            int64_t lastNS = lastSwapTime;
+            float deltaMS = (currentNS - lastNS) / 1000000.0;
+            float fps = 1000.0 * frameCount / deltaMS;
+            if (swapCount != frameCount) {
+                ALOGI("Vulkan Render fps = %.2f", fps);
+            }
+            lastSwapTime = currentNS;
+        }
+    }
 
     ALOGV_IF(present_info->sType != VK_STRUCTURE_TYPE_PRESENT_INFO_KHR,
              "vkQueuePresentKHR: invalid VkPresentInfoKHR structure type %d",
-- 
2.33.1

