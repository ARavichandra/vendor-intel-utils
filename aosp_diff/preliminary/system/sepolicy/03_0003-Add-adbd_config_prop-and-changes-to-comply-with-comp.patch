From 632cd8dbcbbdd972e79d8da2bf34978c1c6bad2d Mon Sep 17 00:00:00 2001
From: Jeevaka Prabu Badrappan <jeevaka.badrappan@intel.com>
Date: Fri, 5 Feb 2021 04:19:56 +0530
Subject: [PATCH] Add adbd_config_prop and changes to comply with complaince

Tracked-On: OAM-95330
Signed-off-by: Jeevaka Prabu Badrappan <jeevaka.badrappan@intel.com>
---
 prebuilts/api/30.0/private/adbd.te           | 1 +
 prebuilts/api/30.0/private/app.te            | 2 ++
 prebuilts/api/30.0/private/netd.te           | 2 ++
 prebuilts/api/30.0/private/property_contexts | 4 ++++
 prebuilts/api/30.0/private/vendor_init.te    | 3 +++
 prebuilts/api/30.0/public/property.te        | 1 +
 private/adbd.te                              | 2 +-
 private/app.te                               | 3 ++-
 private/compat/26.0/26.0.ignore.cil          | 1 +
 private/compat/27.0/27.0.ignore.cil          | 1 +
 private/compat/28.0/28.0.ignore.cil          | 1 +
 private/compat/29.0/29.0.ignore.cil          | 1 +
 private/netd.te                              | 4 ++--
 private/property_contexts                    | 2 +-
 14 files changed, 23 insertions(+), 5 deletions(-)

diff --git a/prebuilts/api/30.0/private/adbd.te b/prebuilts/api/30.0/private/adbd.te
index be4f0f708..e4498b05b 100644
--- a/prebuilts/api/30.0/private/adbd.te
+++ b/prebuilts/api/30.0/private/adbd.te
@@ -89,6 +89,7 @@ set_prop(adbd, exported_ffs_prop)
 
 # Set service.adb.tls.port, persist.adb.wifi. properties
 set_prop(adbd, adbd_prop)
+set_prop(adbd, adbd_config_prop)
 
 # Access device logging gating property
 get_prop(adbd, device_logging_prop)
diff --git a/prebuilts/api/30.0/private/app.te b/prebuilts/api/30.0/private/app.te
index 9882d8f9b..c8392eedf 100644
--- a/prebuilts/api/30.0/private/app.te
+++ b/prebuilts/api/30.0/private/app.te
@@ -41,3 +41,5 @@ neverallow { appdomain -mediaprovider_app } storage_config_prop:file no_rw_file_
 
 # Allow to read graphics related properties.
 get_prop(appdomain, graphics_config_prop)
+
+get_prop(appdomain, adbd_config_prop)
diff --git a/prebuilts/api/30.0/private/netd.te b/prebuilts/api/30.0/private/netd.te
index 41473b73d..f953bce08 100644
--- a/prebuilts/api/30.0/private/netd.te
+++ b/prebuilts/api/30.0/private/netd.te
@@ -9,6 +9,8 @@ domain_auto_trans(netd, dnsmasq_exec, dnsmasq)
 domain_auto_trans(netd, clatd_exec, clatd)
 allow netd clatd:process signal;
 
+get_prop(netd, adbd_config_prop)
+
 # give netd permission to setup iptables rule with xt_bpf, attach program to cgroup, and read/write
 # the map created by bpfloader
 allow netd bpfloader:bpf { prog_run map_read map_write };
diff --git a/prebuilts/api/30.0/private/property_contexts b/prebuilts/api/30.0/private/property_contexts
index 7908bb107..58d099a13 100644
--- a/prebuilts/api/30.0/private/property_contexts
+++ b/prebuilts/api/30.0/private/property_contexts
@@ -100,6 +100,10 @@ sys.trace.              u:object_r:system_trace_prop:s0
 # Fastbootd protocol control property
 fastbootd.protocol    u:object_r:fastbootd_protocol_prop:s0 exact enum usb tcp
 
+# adbd protoctl configuration property
+service.adb.transport   u:object_r:adbd_config_prop:s0 exact string
+service.adb.tcp.port    u:object_r:adbd_config_prop:s0 exact int
+
 # Boolean property set by system server upon boot indicating
 # if device is fully owned by organization instead of being
 # a personal device.
diff --git a/prebuilts/api/30.0/private/vendor_init.te b/prebuilts/api/30.0/private/vendor_init.te
index 6a68f1fed..83f001d6a 100644
--- a/prebuilts/api/30.0/private/vendor_init.te
+++ b/prebuilts/api/30.0/private/vendor_init.te
@@ -5,3 +5,6 @@ dontaudit vendor_init sysfs:dir write;
 
 # TODO(b/140259336) We want to remove vendor_init in the long term but allow for now
 allow vendor_init system_data_root_file:dir rw_dir_perms;
+
+# Let vendor_init set service.adb.tcp.port.
+set_prop(vendor_init, adbd_config_prop)
diff --git a/prebuilts/api/30.0/public/property.te b/prebuilts/api/30.0/public/property.te
index 9a93518d6..43b09db8d 100644
--- a/prebuilts/api/30.0/public/property.te
+++ b/prebuilts/api/30.0/public/property.te
@@ -132,6 +132,7 @@ system_vendor_config_prop(vndk_prop)
 system_vendor_config_prop(virtual_ab_prop)
 
 # Properties with no restrictions
+system_public_prop(adbd_config_prop)
 system_public_prop(audio_prop)
 system_public_prop(bluetooth_a2dp_offload_prop)
 system_public_prop(bluetooth_audio_hal_prop)
diff --git a/private/adbd.te b/private/adbd.te
index 5aa88d4fb..e4498b05b 100644
--- a/private/adbd.te
+++ b/private/adbd.te
@@ -87,7 +87,7 @@ set_prop(adbd, powerctl_prop)
 set_prop(adbd, ffs_prop)
 set_prop(adbd, exported_ffs_prop)
 
-# Set service.adb.tcp.port, service.adb.tls.port, persist.adb.wifi.* properties
+# Set service.adb.tls.port, persist.adb.wifi. properties
 set_prop(adbd, adbd_prop)
 set_prop(adbd, adbd_config_prop)
 
diff --git a/private/app.te b/private/app.te
index 0795546d2..c8392eedf 100644
--- a/private/app.te
+++ b/private/app.te
@@ -1,7 +1,6 @@
 # Allow apps to read the Test Harness Mode property. This property is used in
 # the implementation of ActivityManager.isDeviceInTestHarnessMode()
 get_prop(appdomain, test_harness_prop)
-get_prop(appdomain, adbd_config_prop)
 
 userdebug_or_eng(`perfetto_producer({ appdomain })')
 
@@ -42,3 +41,5 @@ neverallow { appdomain -mediaprovider_app } storage_config_prop:file no_rw_file_
 
 # Allow to read graphics related properties.
 get_prop(appdomain, graphics_config_prop)
+
+get_prop(appdomain, adbd_config_prop)
diff --git a/private/compat/26.0/26.0.ignore.cil b/private/compat/26.0/26.0.ignore.cil
index b395855af..9bf8cf854 100644
--- a/private/compat/26.0/26.0.ignore.cil
+++ b/private/compat/26.0/26.0.ignore.cil
@@ -7,6 +7,7 @@
   ( new_objects
     activity_task_service
     adb_service
+    adbd_config_prop
     adbd_exec
     app_binding_service
     apex_data_file
diff --git a/private/compat/27.0/27.0.ignore.cil b/private/compat/27.0/27.0.ignore.cil
index cb500c9e0..82ef22956 100644
--- a/private/compat/27.0/27.0.ignore.cil
+++ b/private/compat/27.0/27.0.ignore.cil
@@ -6,6 +6,7 @@
 (typeattributeset new_objects
   ( new_objects
     activity_task_service
+    adbd_config_prop
     adb_service
     app_binding_service
     apex_data_file
diff --git a/private/compat/28.0/28.0.ignore.cil b/private/compat/28.0/28.0.ignore.cil
index d24d12d25..2c06dd5a6 100644
--- a/private/compat/28.0/28.0.ignore.cil
+++ b/private/compat/28.0/28.0.ignore.cil
@@ -7,6 +7,7 @@
   ( new_objects
     activity_task_service
     adb_service
+    adbd_config_prop
     apex_data_file
     apex_metadata_file
     apex_mnt_dir
diff --git a/private/compat/29.0/29.0.ignore.cil b/private/compat/29.0/29.0.ignore.cil
index fdea691ea..5a53e055b 100644
--- a/private/compat/29.0/29.0.ignore.cil
+++ b/private/compat/29.0/29.0.ignore.cil
@@ -5,6 +5,7 @@
 (typeattribute new_objects)
 (typeattributeset new_objects
   ( new_objects
+    adbd_config_prop
     aidl_lazy_test_server
     aidl_lazy_test_server_exec
     aidl_lazy_test_service
diff --git a/private/netd.te b/private/netd.te
index 809de6db4..f953bce08 100644
--- a/private/netd.te
+++ b/private/netd.te
@@ -9,10 +9,10 @@ domain_auto_trans(netd, dnsmasq_exec, dnsmasq)
 domain_auto_trans(netd, clatd_exec, clatd)
 allow netd clatd:process signal;
 
-# give netd permission to setup iptables rule with xt_bpf, attach program to cgroup, and read/write
-# the map created by bpfloader
 get_prop(netd, adbd_config_prop)
 
+# give netd permission to setup iptables rule with xt_bpf, attach program to cgroup, and read/write
+# the map created by bpfloader
 allow netd bpfloader:bpf { prog_run map_read map_write };
 
 # in order to invoke side effect of close() on such a socket calling synchronize_rcu()
diff --git a/private/property_contexts b/private/property_contexts
index 91e93a4ca..58d099a13 100644
--- a/private/property_contexts
+++ b/private/property_contexts
@@ -101,8 +101,8 @@ sys.trace.              u:object_r:system_trace_prop:s0
 fastbootd.protocol    u:object_r:fastbootd_protocol_prop:s0 exact enum usb tcp
 
 # adbd protoctl configuration property
-service.adb.tcp.port    u:object_r:adbd_config_prop:s0 exact int
 service.adb.transport   u:object_r:adbd_config_prop:s0 exact string
+service.adb.tcp.port    u:object_r:adbd_config_prop:s0 exact int
 
 # Boolean property set by system server upon boot indicating
 # if device is fully owned by organization instead of being
-- 
2.17.1


